package me.constantindev.ccl.features.module.impl.exploit;

import me.constantindev.ccl.Cornos;
import me.constantindev.ccl.etc.config.MConfMultiOption;
import me.constantindev.ccl.etc.config.MConfNum;
import me.constantindev.ccl.etc.config.MConfToggleable;
import me.constantindev.ccl.etc.helper.Renderer;
import me.constantindev.ccl.etc.render.Notification;
import me.constantindev.ccl.features.module.Module;
import me.constantindev.ccl.features.module.ModuleType;
import net.minecraft.block.*;
import net.minecraft.client.util.math.MatrixStack;
import net.minecraft.network.packet.c2s.play.PlayerActionC2SPacket;
import net.minecraft.util.math.BlockPos;
import net.minecraft.util.math.Direction;
import net.minecraft.util.math.Vec3d;

import java.awt.*;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class AntiAntiXray extends Module {
    MConfNum delay = new MConfNum("delay", 5, 100, 0);
    MConfNum range = new MConfNum("range", 15, 64, 1);
    MConfMultiOption mode = new MConfMultiOption("mode", "ores", new String[]{"ores", "stone", "diamond", "redstone", "allBlocks"});
    MConfToggleable randomize = new MConfToggleable("randomize", true);

    Map<Block, Range> ranges = new HashMap<>();
    List<BlockPos> tail = new ArrayList<>();

    List<BlockPos> queue = new ArrayList<>();
    boolean finishedScanning = false;
    int maxSize = -1;
    Notification scanningNotif;
    BlockPos current = null;
    int delaySpent = 0;

    public AntiAntiXray() {
        super("AntiAntiXray", "fuck you orebfuscator", ModuleType.EXPLOIT);
        mconf.add(delay);
        mconf.add(range);
        mconf.add(mode);
        mconf.add(randomize);

        ranges.put(Blocks.OBSIDIAN, Range.ALL);
        ranges.put(Blocks.CLAY, Range.ALL);
        ranges.put(Blocks.MOSSY_COBBLESTONE, Range.ALL);
        ranges.put(Blocks.DIAMOND_ORE, new Range(1, 16)); // 1, 15
        ranges.put(Blocks.REDSTONE_ORE, new Range(1, 16)); // 1, 15
        ranges.put(Blocks.IRON_ORE, new Range(1, 54)); // 5, 63
        ranges.put(Blocks.COAL_ORE, new Range(1, 52)); // 5, 127
        ranges.put(Blocks.LAPIS_ORE, new Range(13, 33));
        ranges.put(Blocks.GOLD_ORE, new Range(5, 25)); // 5, 33
        ranges.put(Blocks.EMERALD_ORE, new Range(1, 32));
        ranges.put(Blocks.ANCIENT_DEBRIS, new Range(13, 23)); // 13, 119
        ranges.put(Blocks.NETHER_GOLD_ORE, new Range(15, 95)); // 15, 116
        ranges.put(Blocks.NETHER_QUARTZ_ORE, new Range(10, 114)); // 10, 127
    }

    void addQueue(BlockPos p) {
        if (randomize.isEnabled()) {
            queue.add((int) Math.floor(Math.random() * queue.size()), p);
        } else queue.add(p);
    }

    @Override
    public void onEnable() {
        scanningNotif = Notification.create("AntiAntiXray", new String[1], 0xFFFFFF);
        queue.clear();
        int rangeMid = (int) (range.getValue() / 2);
        BlockPos playerPos = Cornos.minecraft.player.getBlockPos();
        boolean acceptAll = mode.value.equalsIgnoreCase("allBlocks");
        for (int x = 0; x < range.getValue(); x++) {
            int actualX = playerPos.getX() - rangeMid + x;
            for (int y = 0; y < range.getValue(); y++) {
                int actualY = playerPos.getY() - rangeMid + y;
                if (actualY < 0 || 255 < actualY) continue;
                for (int z = 0; z < range.getValue(); z++) {
                    int actualZ = playerPos.getZ() - rangeMid + z;
                    BlockPos current = new BlockPos(actualX, actualY, actualZ);
                    BlockState state = Cornos.minecraft.world.getBlockState(current);
                    if (state.isAir()) continue;
                    if (acceptAll) addQueue(current);
                    else {
                        if (mode.value.equalsIgnoreCase("ores") && (state.getBlock() instanceof OreBlock))
                            addQueue(current);
                        else if (mode.value.equalsIgnoreCase("stone") && state.getBlock().is(Blocks.STONE))
                            addQueue(current);
                        else if (mode.value.equalsIgnoreCase("diamond") && state.getBlock().is(Blocks.DIAMOND_ORE))
                            addQueue(current);
                        else if (mode.value.equals("redstone") && state.getBlock().is(Blocks.REDSTONE_ORE))
                            addQueue(current);
                    }

                    if (state.getBlock() instanceof OreBlock || (state.getBlock() instanceof RedstoneOreBlock)) {
                        Block b = state.getBlock();
                        Range r = ranges.get(b);
                        if (r == null) continue;
                        if (!r.isInRange(current.getY())) {
                            Cornos.minecraft.world.setBlockState(current, Blocks.STONE.getDefaultState());
                            queue.remove(current);
                        }
                    }
                }
            }
        }
        finishedScanning = true;
        maxSize = queue.size();
    }

    @Override
    public void onRender(MatrixStack ms, float td) {
        if (current != null) {
            Renderer.renderBlockOutline(new Vec3d(current.getX(), current.getY(), current.getZ()), new Vec3d(1, 1, 1), 50, 255, 100, 255);
        }
        BlockPos prev = null;
        for (BlockPos blockPos : tail.toArray(new BlockPos[0])) {
            if (prev != null && blockPos != null) {
                Renderer.renderLine(new Vec3d(prev.getX() + .5, prev.getY() + .5, prev.getZ() + .5), new Vec3d(blockPos.getX() + .5, blockPos.getY() + .5, blockPos.getZ() + .5), new Color(15, 243, 171), 2);
            }
            prev = blockPos;
        }
    }

    @Override
    public void onFastUpdate() {
        delaySpent++;
        if (delaySpent > delay.getValue()) {
            delaySpent = 0;
        } else return;
        if (!finishedScanning) return;
        if (queue.size() <= 0) {
            this.setEnabled(false);
            return;
        }
        this.current = queue.get(0);
        tail.add(current);
        if (tail.size() > 30) tail.remove(0);
        queue.remove(0);
        scanningNotif.description[0] = (queue.size()) + " blocks remain";

        PlayerActionC2SPacket p = new PlayerActionC2SPacket(PlayerActionC2SPacket.Action.ABORT_DESTROY_BLOCK, current, Direction.DOWN);
        Cornos.minecraft.getNetworkHandler().sendPacket(p);
    }

    @Override
    public void onDisable() {
        scanningNotif.duration = 0;
    }

    static class Range {
        public static final Range ALL = new Range(Integer.MIN_VALUE, Integer.MAX_VALUE);
        private final int min;
        private final int max;

        private Range(int min, int max) {
            this.min = min;
            this.max = max;
        }

        public boolean isInRange(int n) {
            return n <= max && n >= min;
        }
    }
}
